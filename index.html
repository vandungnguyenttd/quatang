<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ƒê√™m Sao Lung Linh</title>
          <style>
            #boot-loader{
              position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
              background:#000;z-index:2147483646;transition:opacity .35s ease;
            }
            #boot-loader .boot-spinner{
              width:56px;height:56px;border:4px solid rgba(255,255,255,.25);
              border-top-color:#fff;border-radius:50%;animation:boot-spin 1s linear infinite;
            }
            @keyframes boot-spin{to{transform:rotate(360deg)}}
            /* Khi app s·∫µn s√†ng ‚Üí ·∫©n loader */
            html.ready #boot-loader{opacity:0;pointer-events:none;visibility:hidden}
          </style>
        <link rel="stylesheet" href="./style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
            rel="stylesheet"
        />
        <link rel="preload" as="image" href="./assets/images/img17.webp" fetchpriority="high" imagesrcset="./assets/images/img17.webp 1x">
        <link rel="icon" href="data:,">
    </head>
    <body>
        <div id="boot-loader" role="status" aria-live="polite" aria-label="ƒêang t·∫£i...">
          <div class="boot-spinner"></div>
        </div>
        <div id="heart-container"></div>
        <canvas id="shooting-canvas"></canvas>
        <div id="star-field"></div>
        <div id="rotate-warning">
            <div class="phone-icon">
                <div class="phone-body"></div>
                <div class="rotate-icon"></div>
            </div>
        </div>

        <div id="mainContent">
            <div class="center-content">
                <img
                    src="./assets/images/img17.webp"
                    alt="Avatar"
                    class="avatar-image"
                />
                <h1 class="main-title">Content page</h1>
                <button
                    class="start-button"
                    id="startButton"
                    onclick="handleStart()"
                >
                B·∫ÆT ƒê·∫¶U
                </button>
            </div>
            <img
                src="./assets/meobantim.gif"
                alt="M√®o b·∫°n tim"
                class="meo-bantim"
            />
        </div>

        <!-- Giao di·ªán ti·∫øp theo -->
        <div id="secondContent" style="display: none">
            <div class="book-wrapper">
                <div class="book">
                    <div class="page">
                        <div class="front cover">
                            <img
                                data-asset="img43"
                                alt="Bia"
                            />
                        </div>
                        <div class="back">
                            <img data-asset="book1" alt="Book page 1"
                            />
                        </div>
                    </div>

                    <div class="page">
                        <div class="front">
                          <img data-asset="book2" alt="Book page 2" />
                        </div>
                        <div class="back">
                          <img data-asset="book3" alt="Book page 3" />
                        </div>
                    </div>

                    <div class="page">
                        <div class="front">
                          <img data-asset="book4" alt="Book page 4" />
                        </div>
                        <div class="back">
                          <img data-asset="book5" alt="Book page 5" />
                        </div>
                    </div>

                    <div class="page">
                        <div class="front">
                          <img data-asset="book6" alt="Book page 6" />
                        </div>
                        <div class="back">
                          <img data-asset="book7" alt="Book page 7" />
                        </div>
                    </div>

                    <div class="page">
                        <div class="front">
                          <img data-asset="book8" alt="Book page 8" />
                        </div>
                        <div class="back">
                          <img data-asset="book9" alt="Book page 9" />
                        </div>
                    </div>
                    <div class="page">
                        <div class="front">
                          <img data-asset="book10" alt="Book page 10" />
                        </div>
                        <div class="back">
                          <img data-asset="book11" alt="Book page 11" />
                        </div>
                    </div>

                    <div class="page">
                            <div class="front">
                              <video data-asset="video1"
                              autoplay
                              muted
                              playsinline
                              webkit-playsinline
                              loop></video>
                            </div>
                        <div class="back cover end">
                          <img data-asset="book12" alt="Book page 12" />
                        </div>
                    </div>
                </div>
            </div>
              <button id="nextButton" onclick="goToThirdContent()">
  <img src="./assets/gift.gif" alt="M√≥n qu√†" 
       style="width:80x; height:80px; vertical-align:middle;">
              </button>
        </div>

        <div id="thirdContent" style="display: none">
            <button id="backButton" class="">Back</button>
            <div class="content-rain" aria-hidden="true"></div>
            <div class="media-rain" aria-hidden="true"></div>
        </div>

        <script type="module" src="script.js" defer></script>
        <script>
(function () {
  function isShown(el){
    const style = window.getComputedStyle(el);
    if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') return false;
    // el ho·∫∑c ancestor c√≥ th·ªÉ hidden v√¨ section ·∫©n ‚Üí offsetParent null (tr·ª´ fixed)
    const rect = el.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) return false;
    // N·∫øu section ·∫©n ho√†n to√†n, rect th∆∞·ªùng 0x0 ‚Üí lo·∫°i
    return true;
  }

  function collectVisibleMedia(){
    const imgs = Array.from(document.querySelectorAll('img')).filter(isShown);
    const vids = Array.from(document.querySelectorAll('video')).filter(isShown);
    return { imgs, vids };
  }

  function waitImages(list){
    return Promise.all(list.map(img => img.complete
      ? Promise.resolve()
      : new Promise(res => { img.addEventListener('load',res,{once:true}); img.addEventListener('error',res,{once:true}); })
    ));
  }

  function waitVideos(list){
    // Ch·ªâ c·∫ßn khung ƒë·∫ßu (loadeddata)
    return Promise.all(list.map(v => {
      // ƒë·∫£m b·∫£o nh·∫π nh√†ng
      if (!v.getAttribute('preload')) v.preload = 'metadata';
      return (v.readyState >= 2)
        ? Promise.resolve()
        : new Promise(res => { v.addEventListener('loadeddata',res,{once:true}); v.addEventListener('error',res,{once:true}); });
    }));
  }

  const waitFonts = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();

  // üîé Thu media ƒëang hi·ªÉn th·ªã ·ªü th·ªùi ƒëi·ªÉm ban ƒë·∫ßu
  const { imgs: visibleImgs, vids: visibleVids } = collectVisibleMedia();

  // ‚ùå Kh√¥ng hard-cap ‚Üí ch·ªâ ·∫©n khi xong th·∫≠t
  Promise.all([ waitImages(visibleImgs), waitVideos(visibleVids), waitFonts ])
    .then(function(){
      document.documentElement.classList.add('app-ready'); // m·ªü UI
      document.documentElement.classList.add('ready');     // ·∫©n loader
      if (typeof window.bootHeavyStuff === 'function') window.bootHeavyStuff();
    });
})();
        </script>

    <!-- START - Khai b√°o ·∫£nh -->
<script type="module">
    import { Assets } from './assets.js';

    /* üîπ Preload s·ªõm c√°c asset ∆∞u ti√™n */
    Assets.preload('img43', 'image', 'high');                       // ·∫£nh b√¨a
    Assets.preloadBatch(Assets.rangeNames('book', 1, 12), 'image', 'high'); // 12 ·∫£nh book
    Assets.preload('video1', 'video');                              // video cu·ªëi s√°ch
    Assets.preload('chicanminhconhau', 'audio');
    Assets.preload('thutay', 'image');
    // T·ª± g√°n src cho t·∫•t c·∫£ ph·∫ßn t·ª≠ c√≥ data-asset
document.querySelectorAll('[data-asset]').forEach(el => {
  const name = el.dataset.asset;
  const src  = Assets.url(name);

  if (el.tagName === 'IMG') {
    el.src = src;
  } else if (el.tagName === 'VIDEO') {
    el.src = src;
    el.playsInline = true;
    el.muted = true;
    el.autoplay = true;
    el.loop = true;
  } else if (el.tagName === 'AUDIO') {
    el.src = src;           // ‚úÖ g√°n src
    el.preload = 'auto';
  }
});
// T·ª± g√°n src v√† k√≠ch ho·∫°t play cho video
document.querySelectorAll('video[data-asset]').forEach(v => {
  v.src = Assets.url(v.dataset.asset);
  v.muted = true;
  v.playsInline = true;

  // M·ªôt s·ªë tr√¨nh duy·ªát iOS c·∫ßn g·ªçi play() b·∫±ng JS ƒë·ªÉ k√≠ch ho·∫°t autoplay
  v.play().catch(err => {
    console.warn("Video autoplay b·ªã ch·∫∑n:", err);
  });
});
</script>
    <!-- END - Khai b√°o ·∫£nh -->

    <!-- START - V√πng nh·∫•p xem ·∫£nh --->

<div id="asset-lightbox" aria-modal="true" role="dialog">
  <button class="close" aria-label="ƒê√≥ng">‚úï</button>
  <figure class="lightbox-figure">
    <img alt="Preview" />
    <figcaption id="asset-caption" class="lightbox-caption"></figcaption>
  </figure>
    <!-- END - V√πng nh·∫•p xem ·∫£nh -->
<audio id="bgAudio" data-asset="chicanminhconhau" preload="auto" loop></audio>

    </body>
</html>
